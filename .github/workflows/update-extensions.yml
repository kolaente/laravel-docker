name: Update Pinned Extensions

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9:00 UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-phpredis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current phpredis version
        id: current
        run: |
          version=$(grep -oP 'PHPREDIS_VERSION[= ]+\K[0-9.]+' apache/Dockerfile.prod | head -1)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Current phpredis version: $version"

      - name: Get latest phpredis release
        id: latest
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          latest=$(gh api repos/phpredis/phpredis/releases/latest --jq '.tag_name')
          echo "version=$latest" >> $GITHUB_OUTPUT
          echo "Latest phpredis version: $latest"

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" != "${{ steps.latest.outputs.version }}" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed: ${{ steps.current.outputs.version }} -> ${{ steps.latest.outputs.version }}"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already up to date"
          fi

      - name: Update Dockerfiles
        if: steps.check.outputs.needs_update == 'true'
        run: |
          old_version="${{ steps.current.outputs.version }}"
          new_version="${{ steps.latest.outputs.version }}"

          # Update all Dockerfiles with pinned phpredis version
          sed -i "s/PHPREDIS_VERSION[= ]*${old_version}/PHPREDIS_VERSION=${new_version}/g" \
            apache/Dockerfile.prod \
            apache/Dockerfile.dev \
            octane/Dockerfile.base

          echo "Updated phpredis from $old_version to $new_version"

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update phpredis to ${{ steps.latest.outputs.version }}"
          title: "chore(deps): update phpredis to ${{ steps.latest.outputs.version }}"
          body: |
            Updates phpredis from `${{ steps.current.outputs.version }}` to `${{ steps.latest.outputs.version }}`.

            **Release notes:** https://github.com/phpredis/phpredis/releases/tag/${{ steps.latest.outputs.version }}

            ---
            *This PR was automatically created by the [update-extensions](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-extensions.yml) workflow.*
          branch: deps/phpredis-${{ steps.latest.outputs.version }}
          delete-branch: true
          labels: dependencies
